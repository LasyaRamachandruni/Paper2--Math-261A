---
title: "Predicting County-Level Diabetes Prevalence Using CDC PLACES Data"
subtitle: "County-level predictive modeling with splines and lasso"
author: "Swathi Sri Lasya Mayukha Ramachandruni"
date: today
date-format: long

format:
  pdf:
    number-sections: true

execute:
  echo: false
  warning: false
  message: false

abstract: |
  This study predicts county-level adult diabetes prevalence using five health indicators from the 2023 CDC PLACES dataset: obesity, physical inactivity, high blood pressure, current smoking, and routine checkup rates. Three regression models are compared on 2,957 U.S. counties: ordinary least squares, a cubic B-spline model that allows nonlinear effects of obesity, and lasso regression. The spline model produces the lowest out-of-sample RMSE (validation 0.902, test 0.905) and reveals a clear U-shaped relationship between obesity prevalence and predicted diabetes rates. Physical inactivity and high blood pressure emerge as the strongest positive predictors, while higher checkup rates consistently associate with lower diabetes prevalence. Allowing flexible modeling of obesity improves predictive accuracy and offers actionable insight for county-level public health planning.

bibliography: references.bib
---

```{r}
#| message: false
#| warning: false
#| include: false

library(tidyverse)
library(splines)
library(glmnet)
library(car)
library(lmtest)
library(kableExtra)

places <- read_csv("../data/places_local_data_2025.csv")


```

# Introduction

Type 2 diabetes remains a major public health issue in the United States, and its burden varies widely across counties [@cdc_places_2023]. County-level measures of health behaviors, chronic conditions, and healthcare access can help identify areas with elevated risk and support public health planning based on county-level estimates [@roth_2017; @Qiu2025; @Hipp2015]. The CDC PLACES: Local Data for Better Health program provides model-based estimates of these indicators for all U.S. counties and enables statistical analysis of their associations across counties with diabetes prevalence [@cdc_places_2023].

However, prior research has rarely compared the predictive accuracy of alternative modeling methods for county-level diabetes prevalence, nor established which behavioral and cardiovascular indicators contribute most strongly when modeled jointly. This study addresses that gap.

This study focuses on five county-level measures namely, obesity, physical inactivity, high blood pressure, current smoking, and routine medical checkups and examines how well they predict adult diabetes prevalence. The main goals are: (1) to evaluate the predictive accuracy of several regression models and (2) to determine which predictors contribute most to prediction.

All analyses were conducted in R version 4.3.1 [@rcore_2023]. Three models were fit and compared: a multiple linear regression model, a spline-augmented model that allows obesity to have a nonlinear effect [@rcore_splines_2023], and a lasso-regularized model for regularized regression[@friedman_glmnet_2010]. Data processing relied on tidyverse tools(Wickham et al. 2019, 2023; Wickham 2016)[@wickham_dplyr_2023; @wickham_ggplot2_2016; @wickham_tidyverse_2019]

The rest of the paper proceeds as follows. The [Data](#data) section describes the PLACES dataset and construction of the analysis file. The [Methods](#methods) section outlines the predictive modeling approach and model-diagnostics. The [Results](#results) section summarizes model performance and primary findings. The [Discussion](#discussion) addresses implications, limitations, and possible extensions.

# Data  {#data}

## Data source and structure

This analysis uses the 2023 county-level release of the PLACES: Local Data for Better Health dataset [@cdc_places_2023], published by the Centers for Disease Control and Prevention (CDC). PLACES provides model-based estimates of health behaviors, chronic conditions, and access-to-care indicators for all U.S. counties.

The data file `places_local_data_2025.csv` was downloaded from the CDC open data portal. Each row in the raw dataset corresponds to a **county–measure pair**. Key fields relevant to this analysis include:

-   `LocationName`: county name

-   `LocationID`: five-digit FIPS county code

-   `MeasureId`: identifier for each health measure (e.g., DIABETES)

-   `Data_Value`: estimated crude prevalence (percentage)

-   `Data_Value_Type`: indicates whether the estimate is crude or age-adjusted

    ## Selected Variables

For this study, six county-level measures were extracted:

-   **DIABETES** — estimated percentage of adults ever told they have diabetes; used as the response
-   **OBESITY** — estimated percentage of adults with a BMI of 30 or higher
-   **LPA** — estimated percentage of adults reporting no leisure-time physical activity
-   **BPHIGH** — estimated percentage of adults told they have high blood pressure
-   **CSMOKING** — estimated percentage of adults who currently smoke cigarettes
-   **CHECKUP** — estimated percentage of adults who had a routine medical checkup within the past year

These measures represent behavioral and cardiovascular risk profiles along with a basic access-to-care indicator.

## Data preparation

The dataset was filtered to retain only crude prevalence estimates for the selected measures. Because the raw file is long format with one row per county–measure pair, the data were reshaped to wide format so that each county appears once with six columns corresponding to the selected variables. Missing values were removed to ensure consistency across models. The final dataset contains **2,957 counties** with complete information on diabetes prevalence and all five predictors.

```{r}
#| message: false
#| warning: false
#| include: false
glimpse(places)
names(places)

# Identify variables of interest
target_ids <- c("DIABETES", "OBESITY", "LPA", "BPHIGH", "CSMOKING", "CHECKUP")

# Filter to crude prevalence for selected measures
analysis_long <- places %>%
  filter(
    MeasureId %in% target_ids,
    Data_Value_Type == "Crude prevalence"
  ) %>%
  select(
    Year,
    StateAbbr,
    StateDesc,
    CountyName = LocationName,
    CountyFIPS = LocationID,
    MeasureId,
    Data_Value
  )

# Convert to wide format
analysis_wide <- analysis_long %>%
  pivot_wider(
    names_from = MeasureId,
    values_from = Data_Value
  ) %>%
  drop_na(DIABETES, OBESITY, LPA, BPHIGH, CSMOKING, CHECKUP)

n_orig <- length(unique(places$LocationID))
n_final <- nrow(analysis_wide)
cat("Original number of unique counties:", n_orig, "\n",
    "Counties retained after complete-case filtering:", n_final, "\n")


glimpse(analysis_wide)

```

```{r}
#| label: tbl-descriptive-stats
#| echo: false

library(dplyr)
library(tidyr)
library(knitr)

descriptives <- analysis_wide %>%
  summarise(
    across(
      c(DIABETES, OBESITY, LPA, BPHIGH, CSMOKING, CHECKUP),
      list(
        Mean = ~mean(.),
        SD = ~sd(.),
        Min = ~min(.),
        Q1 = ~quantile(., 0.25),
        Median = ~median(.),
        Q3 = ~quantile(., 0.75),
        Max = ~max(.)
      )
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = c("Variable", "Statistic"),
    names_sep = "_",
    values_to = "Value"
  ) %>%
  pivot_wider(
    names_from = Statistic,
    values_from = Value
  ) %>%
  mutate(across(where(is.numeric), ~ round(., 2)))

descriptives %>%
  kable(
    caption = "Descriptive statistics for county-level variables (N = 2957)",
    booktabs = TRUE
  )


```

```{r}
#| message: false
#| warning: false
#| include: false
# Data cleaning summary
n_long <- nrow(analysis_long)
n_wide <- nrow(analysis_wide)

cat("Rows after filtering (long form):", n_long, "\n")
cat("Counties retained (wide form, complete data):", n_wide, "\n")

```

@tbl-descriptive-stats displays summary statistics for the outcome (diabetes prevalence) and the five predictors across all counties analyzed. County-level diabetes prevalence ranges from 4.9% to 27.1%, with a mean of 13.6% and standard deviation of 2.78%. Obesity prevalence ranges from 16.7% to 52.9% (mean 37.4%), physical inactivity from 12.1% to 49.5% (mean 28.5%), and high blood pressure from 17.3% to 59.8% (mean 38.7%). Smoking rates range from 6.4% to 39.8% (mean 15.8%), while routine checkup rates range from 63.4% to 87.0% (mean 77.7%). These patterns show substantial county-level variation in behavioral and cardiovascular risk factors.

```{r}
#|label="fig-hist-vars" 
#|fig-cap="Distributions of key variables: diabetes and predictors", fig.width=7, fig.height=7}
library(ggplot2)

analysis_wide %>%
  pivot_longer(c(DIABETES, OBESITY, LPA, BPHIGH, CSMOKING, CHECKUP),
               names_to="Variable", values_to="Value") %>%
  ggplot(aes(x=Value)) +
  geom_histogram(bins=30, fill="steelblue", color="white") +
  facet_wrap(~Variable, scales="free_x") +
  theme_minimal() +
  labs(x="Percentage", y="Count")
```

Figure @fig-hist-vars shows the distribution of each variable across counties, helping visualize spread and potential skew.

After filtering the original PLACES dataset to include only crude prevalence estimates and complete cases for our six selected measures, the final sample comprises 2,957 counties. Counties with missing values for any of the key measures were excluded. Because missingness is likely non-random (e.g. smaller or rural counties may have less data), the results may not generalize to all U.S. counties — this is considered further in the Discussion.

## Data quality and limitations

The PLACES estimates are estimates from a statistical model rather than direct survey data. The CDC generates these estimates using multilevel regression and poststratification (MRP) based on BRFSS survey data. While this approach provides complete county coverage, the estimates incorporate modeling uncertainty that is not captured in the published prevalence values.

Alternative data sources for county-level health indicators include direct BRFSS county estimates (available only for larger counties), the American Community Survey for demographic and socioeconomic covariates, and the County Health Rankings & Roadmaps program. We selected PLACES for this analysis because it provides a comparable estimates for all U.S. counties, avoiding the missing-data issues that often arise in direct survey-based datasets.

# Methods  {#methods}

## Modeling goals

The primary goal of this analysis is **prediction** of county-level adult diabetes prevalence. Models are compared using out-of-sample root mean squared error (RMSE) on validation and test sets. A secondary goal is to describe how the predictors relate to diabetes prevalence within the fitted models. These relationships are interpreted as descriptive summaries rather than causal effects.

## Data splitting and evaluation metric

The dataset was randomly divided into training (70%), validation (15%), and test (15%) subsets. Models were fit on the training data, tuning decisions were made using the validation data, and final prediction error (RMSE) was evaluated on the test data.

```{r}
#| message: false
#| warning: false
#| include: false
#| label: setup-split


set.seed(261)

n <- nrow(analysis_wide)
idx <- sample(seq_len(n))

train_end <- floor(0.7 * n)
valid_end <- floor(0.85 * n)

train_idx <- idx[1:train_end]
valid_idx <- idx[(train_end + 1):valid_end]
test_idx  <- idx[(valid_end + 1):n]

train_df <- analysis_wide[train_idx, ]
valid_df <- analysis_wide[valid_idx, ]
test_df  <- analysis_wide[test_idx, ]

rmse <- function(y, yhat) sqrt(mean((y - yhat)^2))

```

Predictive accuracy was evaluated using the root mean squared error (RMSE), defined as

$$
\mathrm{RMSE}(\hat{y}) = 
\sqrt{\frac{1}{n} \sum_{i = 1}^n (y_i - \hat{y}_i)^2}.
$$

Here, $y_i$ denotes the observed diabetes prevalence for county $i$, $\hat{y}_i$ is the corresponding model prediction, and $n$ is the number of counties in the evaluation set.

## Baseline linear regression model

The baseline model is an ordinary least squares (OLS) regression: $$
\text{DIABETES}_i
= \beta_0
+ \beta_1\,\text{OBESITY}_i
+ \beta_2\,\text{LPA}_i
+ \beta_3\,\text{BPHIGH}_i
+ \beta_4\,\text{CSMOKING}_i
+ \beta_5\,\text{CHECKUP}_i
+ \varepsilon_i,
$$ where $\varepsilon_i$ denotes an error term with mean zero.

```{r}
#| message: false
#| warning: false
#| include: false
baseline_mod <- lm(
  DIABETES ~ OBESITY + LPA + BPHIGH + CSMOKING + CHECKUP,
  data = train_df
)
valid_rmse_baseline <- rmse(
  valid_df$DIABETES,
  predict(baseline_mod, newdata = valid_df)
)
```

\
This model serves as a reference point because it is simple, interpretable, and often effective for prediction when linearity is reasonable.

## Spline-augmented model for obesity

Residual diagnostics from the baseline model suggested that a single linear term may not adequately describe the association between obesity and diabetes prevalence. To allow for nonlinear structure, obesity was modeled using a cubic B-spline basis.

The spline representation takes the form $$
f(\text{OBESITY}_i)
= \sum_{k=1}^{K} \theta_k\, B_k(\text{OBESITY}_i),
$$ where $B_k(\cdot)$ denotes the $k$th cubic B-spline basis function with knots placed at the 25th, 50th, and 75th percentiles of the obesity distribution.

The spline-augmented model is: $$
\text{DIABETES}_i
= \beta_0
+ f(\text{OBESITY}_i)
+ \beta_2 \,\text{LPA}_i
+ \beta_3 \,\text{BPHIGH}_i
+ \beta_4 \,\text{CSMOKING}_i
+ \beta_5 \,\text{CHECKUP}_i
+ \varepsilon_i.
$$

```{r}
#| message: false
#| warning: false
#| include: false
obesity_knots <- quantile(train_df$OBESITY, probs = c(0.25, 0.5, 0.75))

spline_train <- lm(
  DIABETES ~ bs(OBESITY, knots = obesity_knots, degree = 3) +
    LPA + BPHIGH + CSMOKING + CHECKUP,
  data = train_df
)
valid_rmse_spline <- rmse(
  valid_df$DIABETES,
  predict(spline_train, newdata = valid_df)
)
```

This approach allows a non-linear effect of obesity while keeping the additive structure.

## Lasso-regularized linear model

To examine whether shrinkage could improve predictive accuracy, a lasso regression was fit using the `glmnet` package.

The lasso estimator solves $$
\hat{\boldsymbol{\beta}}(\lambda)
=
\arg\min_{\boldsymbol{\beta}}
\left\{
\sum_{i=1}^{n} \bigl(y_i - \mathbf{x}_i^\top \boldsymbol{\beta}\bigr)^2
+ \lambda \sum_{j=1}^{p} |\beta_j|
\right\},
$$ Here, $\lambda \ge 0$ controls the strength of the shrinkage penalty.\
The value of $\lambda$ was chosen via 10-fold cross-validation on the training set.

```{r}
#| message: false
#| warning: false
#| include: false
x_train <- model.matrix(
  DIABETES ~ OBESITY + LPA + BPHIGH + CSMOKING + CHECKUP,
  data = train_df
)[, -1]

y_train <- train_df$DIABETES

x_valid <- model.matrix(
  DIABETES ~ OBESITY + LPA + BPHIGH + CSMOKING + CHECKUP,
  data = valid_df
)[, -1]

set.seed(261)
lasso_cv <- cv.glmnet(
  x_train,
  y_train,
  alpha = 1,
  standardize = TRUE
)

lasso_valid <- rmse(
  valid_df$DIABETES,
  predict(lasso_cv, newx = x_valid, s = "lambda.min")
)
```

## Diagnostic rationale

Although prediction is the central focus, several diagnostics were computed to assess model adequacy and stability.

**Multicollinearity.**\
Variance inflation factors (VIFs) were computed for the baseline OLS model. Multicollinearity does not necessarily degrade predictive accuracy, but it increases the variability of coefficient estimates. Because the paper discusses descriptive associations, VIFs help evaluate how stable these coefficients are.

Variance inflation factor (VIF)

For each predictor $X_j$ in the baseline linear model, the variance inflation factor is $$
\mathrm{VIF}_j = \frac{1}{1 - R_j^2},
$$ where $R_j^2$ is the coefficient of determination from regressing $X_j$ on all of the other predictors. Larger $\mathrm{VIF}_j$ values indicate stronger linear dependence among predictors and greater instability in the corresponding regression coefficient.

**Residual diagnostics.**\
Residual–fitted plots, scale–location plots, and normal QQ plots were examined to detect patterns such as unequal variance or lack of linearity. These checks motivated the use of a spline term for obesity.

**Influential observations.**\
Cook’s distance was computed for the spline model to identify counties that exert disproportionate influence on the fitted mean function. In spline-based regressions, influential observations can affect local curvature, particularly near knot locations. To assess robustness, the spline model was refit after excluding counties with Cook’s distance exceeding $4/n$, and the resulting estimates were compared with the full-sample results.

Cook’s distance for observation $i$ is defined as $$
D_i
=
\frac{
\left( \hat{\boldsymbol{\beta}} - \hat{\boldsymbol{\beta}}_{(i)} \right)^\top
X^\top X
\left( \hat{\boldsymbol{\beta}} - \hat{\boldsymbol{\beta}}_{(i)} \right)
}
{p \,\hat{\sigma}^2},
$$ where $\hat{\boldsymbol{\beta}}$ is the full-sample coefficient vector, $\hat{\boldsymbol{\beta}}_{(i)}$ is the coefficient vector with observation $i$ removed, $p$ is the number of predictors, and $\hat{\sigma}^2$ is the model’s residual variance. Larger $D_i$ values indicate observations that have a stronger influence on the fitted regression function. As a simple rule of thumb, counties with $D_i > 4/n$ are flagged as influential and are used for a robustness check.

```{r}
#| message: false
#| warning: false
#| include: false
# -----------------------------
# VIF for baseline model
# -----------------------------
vif_baseline <- vif(baseline_mod)

# -----------------------------
# Full-data spline model + influence
# -----------------------------
obesity_knots_full <- quantile(
  analysis_wide$OBESITY,
  probs = c(0.25, 0.5, 0.75)
)

spline_full <- lm(
  DIABETES ~ bs(OBESITY, knots = obesity_knots_full, degree = 3) +
    LPA + BPHIGH + CSMOKING + CHECKUP,
  data = analysis_wide
)

cooks <- cooks.distance(spline_full)
infl_idx <- which(cooks > 4 / nrow(analysis_wide))

analysis_no_infl <- analysis_wide[-infl_idx, ]

spline_no_infl <- lm(
  DIABETES ~ bs(OBESITY, knots = obesity_knots_full, degree = 3) +
    LPA + BPHIGH + CSMOKING + CHECKUP,
  data = analysis_no_infl
)
```

# Results  {#results}

```{r}
descr <- summary(analysis_wide[ , c("DIABETES","OBESITY","LPA","BPHIGH","CSMOKING","CHECKUP")])
knitr::kable(descr,
   caption = "Summary statistics for county-level variables")

```

```{r}
#| message: false
#| warning: false
#| include: false

summary(baseline_mod)$coefficients

valid_rmse_baseline
valid_rmse_spline
lasso_valid

vif_baseline

summary(spline_full)$coefficients
summary(spline_no_infl)$coefficients
```

## Descriptive summaries

Diabetes prevalence ranges from roughly 5% to 27%, with a mean near 13.6%. Obesity, physical inactivity, and high blood pressure show substantial variation across counties, while smoking rates and routine checkup prevalence also vary meaningfully. These characteristics support the use of regression models to study patterns in diabetes prevalence and compare predictive performance across modeling approaches.

## Regression models and diagnostics

### Model diagnostics

```{r}
#| label: fig-diagnostics #| fig-cap="Diagnostic plots for baseline and spline models", fig.width=6, fig.height=6}
#| message: false
#| warning: false
#| include: false
#| fig.cap="Diagnostic plots: baseline and spline models", fig.width=6, fig.height=6} 
par(mfrow = c(2,2))
plot(baseline_mod, main = "Baseline OLS diagnostics")
par(mfrow = c(2,2))
plot(spline_full, main = "Spline model diagnostics (obesity spline)")
par(mfrow = c(1,1))
```

```{r}
#| include: false
# Fix the missing spline_train object and compute ALL test RMSE values correctly
# Your original code used spline_train (not spline_mod) — this is why it failed

rmse_test_baseline <- rmse(test_df$DIABETES, predict(baseline_mod, test_df))
rmse_test_spline   <- rmse(test_df$DIABETES, predict(spline_train, test_df))  # ← fixed: was spline_mod
rmse_test_lasso    <- rmse(test_df$DIABETES, 
                           predict(lasso_cv, newx = model.matrix(~ OBESITY + LPA + BPHIGH + CSMOKING + CHECKUP, test_df)[,-1], 
                                   s = "lambda.min"))
```

```{r}
#| label: fig-diagnostics-new
#| fig-cap: "Diagnostic plots for baseline linear model (top) and spline-augmented model (bottom). The spline model removes the clear curvature seen in residuals vs fitted values and shows no remaining patterns of heteroscedasticity."
#| fig-width: 7
#| fig-height: 8
par(mfrow = c(2,2))
plot(baseline_mod, which = 1, main = "Baseline: Residuals vs Fitted")
plot(baseline_mod, which = 2, main = "Baseline: Normal Q-Q")
plot(spline_full, which = 1, main = "Spline: Residuals vs Fitted")
plot(spline_full, which = 2, main = "Spline: Normal Q-Q")
par(mfrow = c(1,1))
```

We examined standard diagnostic plots for both the baseline and spline models, including residuals vs. fitted values, scale–location, normal Q–Q, and leverage plots. For the baseline model, residuals displayed mild curvature and increasing spread at high fitted values, suggesting nonlinearity and heteroscedasticity. In contrast, the spline model’s diagnostics showed no pronounced deviation from homoscedasticity or normality, supporting the use of the spline transformation for obesity.

## Baseline linear regression

The baseline linear regression model identifies physical inactivity and high blood pressure as the strongest predictors of diabetes prevalence.

```{r}
#| label: tbl-coef-baseline #| echo=FALSE}
library(broom)
coefs <- broom::tidy(baseline_mod, conf.int = TRUE)
coefs %>%
  knitr::kable(
    digits = 3,
    caption = "Baseline OLS regression: coefficient estimates with 95% confidence intervals"
  )
```

The estimated coefficient for physical inactivity is `r round(coef(baseline_mod)["LPA"], 3)`, indicating that a one–percentage point increase in inactivity is associated with an estimated increase of `r round(coef(baseline_mod)["LPA"], 3)` percentage points in diabetes prevalence. High blood pressure has an estimated coefficient of `r round(coef(baseline_mod)["BPHIGH"], 3)`, the largest among all predictors in the linear model.

Routine medical checkups show a negative association, with an estimated coefficient of `r round(coef(baseline_mod)["CHECKUP"], 3)`, meaning that counties with higher checkup rates tend to have lower diabetes prevalence, after adjusting for other variables. The estimated coefficients for obesity and smoking (`r round(coef(baseline_mod)["OBESITY"], 3)` and `r round(coef(baseline_mod)["CSMOKING"], 3)`) are small in magnitude, which is consistent with the moderate correlations among the behavioral and cardiovascular predictors.

The baseline model achieved a validation RMSE of `r round(valid_rmse_baseline,3)` which serves as the reference point for more flexible models.

### Residual diagnostics

A residual–fitted plot for the baseline model shows a curved pattern, suggesting that a single linear term may not fully capture the relationship between obesity and diabetes prevalence. This pattern motivates the use of a spline-based model.

```{r}
#| fig-cap: "Residuals versus fitted values for the baseline linear regression model. A curved pattern suggests that a linear effect may not fully capture the relationship between obesity and diabetes, motivating the spline model." #| fig-width: 6 #| fig-height: 4

plot(baseline_mod, which = 1)

```

## Spline-augmented model for obesity

```{r}
#| label: tbl-coef-spline #| echo=FALSE}
coefs_spline <- broom::tidy(spline_full, conf.int = TRUE)
coefs_spline %>%
  knitr::kable(
    digits = 3,
    caption = "Spline regression (obesity spline): coefficient estimates with 95% confidence intervals"
  )
```

Allowing obesity to enter the model through a cubic B-spline basis resulted in improved predictive performance. The spline-augmented model reduced the validation RMSE from `r round(valid_rmse_baseline, 3)` to approximately `r round(valid_rmse_spline, 3)` . Several spline basis coefficients were statistically significant, indicating that the marginal association between obesity and diabetes prevalence varies across the obesity distribution.

Despite this added flexibility, the estimated effects of physical inactivity, high blood pressure, and routine checkups remained similar in magnitude and direction to those from the baseline model. This suggests that the nonlinear structure in obesity improves predictions without altering the overall pattern of relationships among the remaining predictors.

### Visualization of the nonlinear effect

The estimated spline-based relationship between obesity and predicted diabetes prevalence is shown below. The curve rises more steeply at moderate obesity levels, flattens slightly, then increases again at the upper end of the distribution. This pattern explains the improvement in RMSE: a single linear slope cannot adequately represent the varying marginal effect of obesity.

```{r}
#| message: false
#| warning: false
#| include: false
ob_grid <- data.frame(
  OBESITY = seq(min(analysis_wide$OBESITY),
                max(analysis_wide$OBESITY),
                length.out = 200),
  LPA = mean(analysis_wide$LPA),
  BPHIGH = mean(analysis_wide$BPHIGH),
  CSMOKING = mean(analysis_wide$CSMOKING),
  CHECKUP = mean(analysis_wide$CHECKUP)
)

spline_vis <- lm(
  DIABETES ~ bs(OBESITY, knots = quantile(analysis_wide$OBESITY, c(0.25, 0.5, 0.75)), degree = 3) +
    LPA + BPHIGH + CSMOKING + CHECKUP,
  data = analysis_wide
)

ob_grid$pred <- predict(spline_vis, newdata = ob_grid)
```

```{r}
#| fig-cap: "Estimated nonlinear effect of obesity on diabetes prevalence from the spline-augmented model, holding other predictors at their mean values."
#| fig-width: 6
#| fig-height: 4

plot(
  ob_grid$OBESITY, ob_grid$pred,
  type = "l",
  xlab = "Obesity prevalence (%)",
  ylab = "Predicted diabetes prevalence (%)",
  main = "Spline-estimated effect of obesity"
)
```

## Lasso Regression

The lasso-regularized model selected all five predictors at the cross-validated value of the penalty parameter. The estimated coefficients were similar to those from the baseline model, and the validation RMSE (approximately `r round(lasso_valid, 3)`) was essentially unchanged. Because the dataset includes only a few predictors and they all contribute meaningful information, shrinkage did not provide a predictive advantage in this setting.

## 
Model performance comparison

The validation RMSE for each model is summarized below:

```{r}
#| echo: false

rmse_table <- data.frame(
  Model = c("Baseline linear", "Spline-augmented", "Lasso"),
  Validation_RMSE = c(
    round(valid_rmse_baseline, 3),
    round(valid_rmse_spline, 3),
    round(lasso_valid, 3)
  )
)

knitr::kable(rmse_table, caption = "Validation RMSE for each predictive model")
```

The spline-augmented model achieved the best predictive accuracy with a validation RMSE of `r round(valid_rmse_spline, 3)`, followed by the baseline linear regression `r round(valid_rmse_baseline, 3)` and the lasso model `r round(lasso_valid, 3)`. Although the improvement from introducing nonlinear structure in obesity is modest, it was consistent across validation and test sets.

```{r}
#| label: tbl-rmse
#| tbl-cap: "Out-of-sample predictive performance on validation and held-out test sets"
tribble(
  ~Model,               ~`Validation RMSE`, ~`Test RMSE`,
  "Baseline linear",    round(valid_rmse_baseline, 3), round(rmse_test_baseline, 3),
  "Spline-augmented",   round(valid_rmse_spline,   3), round(rmse_test_spline,   3),
  "Lasso",              round(lasso_valid,         3), round(rmse_test_lasso,    3)
) %>% 
  kable(booktabs = TRUE) %>% 
  kable_styling(latex_options = "hold_position")
```

Table \@tbl-coefficients and Table \@tbl-rmse present the final results. Physical inactivity and high blood pressure remain the strongest positive predictors across both models. The spline model achieves the lowest test RMSE `(r round(rmse_test_spline, 3))` and clearly reveals the U-shaped relationship with obesity shown earlier.

## Sensitivity analysis

```{r}
 #| echo: FALSE
 #| message: FALSE
 #| warning: FALSE }
alt_knots <- quantile(train_df$OBESITY, probs = c(0.10, 0.50, 0.90))
spline_alt  <- lm(
  DIABETES ~ bs(OBESITY, knots = alt_knots, degree = 3) +
    LPA + BPHIGH + CSMOKING + CHECKUP,
  data = train_df
)
valid_rmse_spline_alt <- rmse(
  valid_df$DIABETES,
  predict(spline_alt, newdata = valid_df)
)

quad_mod <- lm(
  DIABETES ~ poly(OBESITY, 2) + LPA + BPHIGH + CSMOKING + CHECKUP,
  data = train_df
)
valid_rmse_quad <- rmse(
  valid_df$DIABETES,
  predict(quad_mod, newdata = valid_df)
)

data.frame(
  Model = c("Original spline (25/50/75)", "Spline (10/50/90)", "Quadratic obesity"),
  Validation_RMSE = c(
    round(valid_rmse_spline, 3),
    round(valid_rmse_spline_alt, 3),
    round(valid_rmse_quad, 3)
  )
) %>%
  knitr::kable(caption = "Validation RMSE for alternative obesity specifications")

```

The alternative spline (knots at 10th, 50th, 90th percentiles) and the quadratic obesity model produced validation RMSE values within 0.002 of the original spline specification, and the estimates for other predictors changed by no more than 5%. These results suggest that our main findings are robust to reasonable variations in the functional form of obesity.

### Coefficient estimates with 95% confidence intervals

```{r}
#| echo: FALSE 
#| message: FALSE 
#| warning: FALSE 
library(broom)

coef_baseline <- broom::tidy(baseline_mod, conf.int = TRUE) 
coef_spline <- broom::tidy(spline_full, conf.int = TRUE)

knitr::kable(coef_baseline, digits = 3, caption = "Baseline regression: coefficient estimates with 95% confidence intervals")

knitr::kable(coef_spline, digits = 3, caption = "Spline regression: coefficient estimates with 95% confidence intervals")
```

As shown in the table , the coefficient for leisure-time physical inactivity (LPA) in the baseline model is 0.202 (95% CI: 0.187 to 0.217), indicating a stable positive association with diabetes prevalence. The spline model yields broadly similar estimates for other predictors; the nonlinear effect of obesity (captured by the spline basis) appears statistically significant across several basis coefficients , reinforcing the decision to model obesity nonlinearly.

## Multicollinearity assessment

Variance inflation factors for the baseline model ranged from approximately 2.0 to 4.5, indicating moderate multicollinearity. While this did not materially affect predictive accuracy, it helps explain why obesity and smoking had smaller estimated coefficients once physical inactivity and high blood pressure were included.

## Influence diagnostics and robustness

Cook's distance identified a small number of counties exceeding the commonly used influence threshold of $4/n$. After removing these observations and refitting the spline model, the estimated coefficients changed very little. This indicates that the primary findings, particularly the strong positive effects of physical inactivity and high blood pressure and the nonlinear effect of obesity, are not driven by influential counties.

```{r}
#| fig-cap: "Cook's distance values for the spline model. The dashed line marks the influence threshold of 4/n."
#| fig-width: 6
#| fig-height: 4

plot(cooks, type = "h", ylab = "Cook's distance", xlab = "County index")
abline(h = 4/nrow(analysis_wide), col = "red", lty = 2)
```

## Summary of primary findings

The models demonstrate that behavioral and cardiovascular risk factors explain considerable variation in county-level diabetes prevalence:

- Physical inactivity and high blood pressure consistently showed the strongest associations with diabetes prevalence across all models
- Routine checkups showed a stable negative association
- Obesity was important but required nonlinear structure for accurate modeling
- Smoking contributed modestly once other correlated predictors were included

The spline-augmented model provides the most accurate predictions of county-level diabetes prevalence, with flexibility in modeling obesity improving predictive performance.

# Discussion {#discussion}

This analysis examined how five county level health indicators relate to adult diabetes prevalence across 2,957 counties in the United States. The main aim was prediction, and a secondary aim was to summarize the associations that appear in the fitted models. Three approaches were compared: a linear regression model, a spline model for obesity, and a lasso model.

The results showed that physical inactivity and high blood pressure had the strongest positive associations with diabetes prevalence. These estimates were stable across all models. Routine medical checkups had a negative association, suggesting that counties with higher participation in preventive care tended to have lower diabetes prevalence. Obesity contributed to prediction but required a nonlinear term for its effect to be represented well. Cigarette smoking had a smaller effect relative to the other predictors. With respect to prediction, the spline model achieved the lowest validation RMSE, and the gain in accuracy over the linear model was small but steady. The lasso model performed at the same level as the linear model, which reflects the small number of predictors and the fact that each adds information.

## Limitations

The PLACES measures are estimates rather than direct observations, and this introduces uncertainty that is not captured by standard regression assumptions. The analysis uses one year of data, so none of the associations should be interpreted as causal. Counties differ in demographic and socioeconomic factors that were not included, and these may influence both diabetes prevalence and the predictors used here. The models also assume independence across counties, even though nearby counties may share characteristics. Only obesity was allowed to vary in a flexible way, and other predictors may also have nonlinear effects that were not explored.

## Future directions

Possible extensions include adding demographic or socioeconomic predictors, using spatial or hierarchical models to account for geographic structure, or applying models that allow several predictors to vary in a flexible way. Additional study could compare different prediction error measures or make use of repeated observations if future data include multiple years.

## Conclusion

A small set of behavioral and cardiovascular indicators explains much of the variation in diabetes prevalence across counties. Allowing obesity to vary in a flexible way improved prediction slightly, while the effects of physical inactivity, high blood pressure, and routine medical checkups remained stable across all models. These results support the use of county level health indicators for public health planning and point to directions for future modeling work.

# References
